container_commands:
  01_backup_nginx:
    command: "cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.ebbackup"
    test: "[ ! -f /etc/nginx/nginx.conf.ebbackup ]"
  02_fix_nginx_config:
    command: |
      # Add our configuration after the mime.types include
      if ! grep -q "types_hash_max_size 2048" /etc/nginx/nginx.conf; then
        sed -i '/include.*\/etc\/nginx\/mime\.types;/a\
        \    types_hash_max_size 2048;\
        \    types_hash_bucket_size 128;\
        \    server_names_hash_bucket_size 128;\
        \    proxy_buffer_size 512k;\
        \    proxy_buffers 64 512k;\
        \    proxy_busy_buffers_size 1024k;\
        \    large_client_header_buffers 64 512k;\
        \    client_header_buffer_size 512k;\
        \    proxy_read_timeout 300s;\
        \    proxy_connect_timeout 300s;\
        \    proxy_send_timeout 300s;' /etc/nginx/nginx.conf
      fi
  03_test_nginx_config:
    command: "nginx -t"
  04_reload_nginx:
    command: "systemctl reload nginx"