feature:
  id: ontology-aws-integration-ui
  name: AWS Integration UI/UX for Enterprise Ontology
  description: |
    Build visual interfaces for all AWS services integrated with the ontology system, including
    DynamoDB query builder, Glue data catalog browser, Athena SQL interface, CloudWatch time-series
    visualization, QuickSight dashboard embedding, Kendra semantic search, and S3 file browser.
  priority: P0
  story_points: 21
  estimated_weeks: 2
  owner: Platform Team
  tags:
    - aws-integration
    - dynamodb
    - glue
    - athena
    - cloudwatch
    - quicksight
    - kendra
    - s3

services:
  backend:
    - core/src/services/aws/dynamodb.ts
    - core/src/services/aws/glue.ts
    - core/src/services/aws/athena.ts
    - core/src/services/aws/cloudwatch.ts
    - core/src/services/aws/quicksight.ts
    - core/src/services/aws/kendra.ts
    - core/src/services/aws/s3.ts

  frontend:
    - platform/src/app/ontology/aws/dynamodb/
    - platform/src/app/ontology/aws/glue/
    - platform/src/app/ontology/aws/athena/
    - platform/src/app/ontology/aws/cloudwatch/
    - platform/src/app/ontology/aws/quicksight/
    - platform/src/app/ontology/aws/kendra/
    - platform/src/app/ontology/aws/s3/

  libraries:
    - @aws-sdk/client-dynamodb
    - @aws-sdk/client-glue
    - @aws-sdk/client-athena
    - @aws-sdk/client-cloudwatch
    - @aws-sdk/client-quicksight
    - @aws-sdk/client-kendra
    - @aws-sdk/client-s3
    - @monaco-editor/react

user_stories:
  # ==========================================================================
  # STORY 1: DynamoDB Visual Query Builder
  # ==========================================================================
  - id: US-AWS-001
    title: As a data analyst, I want to query DynamoDB tables visually
    description: |
      I need a visual query builder for DynamoDB so I can construct queries without
      writing complex filter expressions manually.

    priority: P0
    story_points: 5

    acceptance_criteria:
      - Given I select an ontology entity type
        When I open the DynamoDB query builder
        Then I see a visual interface with table name, filters, and projection fields

      - Given I want to filter results
        When I add filter conditions
        Then I can choose operators (equals, greater than, contains, begins_with, etc.)

      - Given I construct a query
        When I execute it
        Then I see results in a table with pagination

      - Given query results are displayed
        When I click on a row
        Then I see the full item details in a side panel

    test_scenarios:
      - name: Build and execute simple query
        type: integration
        setup: |
          await seedDynamoDBTable('pmbook-contract', [
            { id: 'c1', contractNumber: 'ABC123', status: 'active', totalValue: 1000000 },
            { id: 'c2', contractNumber: 'ABC124', status: 'draft', totalValue: 500000 },
            { id: 'c3', contractNumber: 'ABC125', status: 'active', totalValue: 2000000 }
          ]);
        steps:
          - action: open_query_builder
            params:
              typeName: contract
            expect:
              table_name_displayed: pmbook-contract
              filters_section_visible: true
              projection_section_visible: true

          - action: add_filter
            params:
              attribute: status
              operator: equals
              value: active
            expect:
              filter_added: true

          - action: execute_query
            expect:
              success: true
              results.length: 2
              results.every(r => r.status === 'active'): true

      - name: Query using GSI
        type: integration
        setup: |
          await seedDynamoDBTable('pmbook-contract', [
            { id: 'c1', contractNumber: 'ABC123', status: 'active' },
            { id: 'c2', contractNumber: 'ABC124', status: 'draft' }
          ]);
        steps:
          - action: select_index
            params:
              indexName: status-index
            expect:
              index_selected: true
              partition_key_field: status

          - action: add_filter
            params:
              attribute: status
              operator: equals
              value: active
            expect:
              filter_valid: true

          - action: execute_query
            expect:
              success: true
              query_uses_gsi: true

      - name: View item details
        type: e2e
        steps:
          - action: execute_query
            params:
              typeName: contract

          - action: click_row
            row_index: 0
            expect:
              detail_panel_visible: true
              detail_panel_shows_all_fields: true

      - name: Export query results
        type: integration
        setup: |
          await executeQuery({ typeName: 'contract', filters: { status: 'active' } });
        steps:
          - action: export_results
            params:
              format: csv
            expect:
              success: true
              file_type: text/csv
              rows_gt: 0

  # ==========================================================================
  # STORY 2: Glue Data Catalog Browser
  # ==========================================================================
  - id: US-AWS-002
    title: As a data engineer, I want to browse the Glue data catalog
    description: |
      I need to browse databases, tables, and schemas in AWS Glue so I can understand
      available data sources and their structure.

    priority: P0
    story_points: 3

    acceptance_criteria:
      - Given I open the Glue catalog browser
        When the page loads
        Then I see a list of databases

      - Given I select a database
        When I click on it
        Then I see tables in that database

      - Given I select a table
        When I click on it
        Then I see the schema with column names, types, and descriptions

      - Given I want to use a Glue table in ontology
        When I click "Map to Entity Type"
        Then I can create an ontology node pointing to the Glue table

    test_scenarios:
      - name: Browse databases and tables
        type: integration
        setup: |
          await createGlueDatabases([
            { name: 'pmbook_db', description: 'PMBook data' },
            { name: 'analytics_db', description: 'Analytics data' }
          ]);
          await createGlueTables('pmbook_db', [
            { name: 'contracts', columns: [
              { name: 'id', type: 'string' },
              { name: 'contract_number', type: 'string' }
            ]},
            { name: 'clins', columns: [
              { name: 'id', type: 'string' },
              { name: 'clin_number', type: 'string' }
            ]}
          ]);
        steps:
          - action: navigate_to
            url: /ontology/aws/glue
            expect:
              databases_visible: true
              databases.length: 2

          - action: click_database
            database_name: pmbook_db
            expect:
              tables_visible: true
              tables.length: 2

          - action: click_table
            table_name: contracts
            expect:
              schema_visible: true
              columns.length: 2
              columns[0].name: id
              columns[0].type: string

      - name: View table partitions
        type: integration
        setup: |
          await createGlueTable('analytics_db', 'events', {
            partitionKeys: ['year', 'month', 'day']
          });
        steps:
          - action: click_table
            table_name: events

          - action: view_partitions
            expect:
              partitions_tab_visible: true
              partition_keys.length: 3

      - name: Map Glue table to ontology node
        type: integration
        setup: |
          await createGlueTable('pmbook_db', 'contracts', {
            columns: [
              { name: 'id', type: 'string' },
              { name: 'contract_number', type: 'string' }
            ]
          });
        steps:
          - action: click_table
            table_name: contracts

          - action: click_map_to_ontology
            expect:
              mapping_dialog_visible: true

          - action: create_ontology_node
            params:
              name: Glue Contract
              type: glueContract
              dataSource: glue://pmbook_db/contracts
            expect:
              success: true
              node_created: true

  # ==========================================================================
  # STORY 3: Athena SQL Interface
  # ==========================================================================
  - id: US-AWS-003
    title: As a data analyst, I want to query data with Athena SQL
    description: |
      I need an SQL interface for Athena so I can run ad-hoc queries on data lake tables
      and analyze data without DynamoDB limitations.

    priority: P0
    story_points: 5

    acceptance_criteria:
      - Given I open the Athena SQL interface
        When I see the editor
        Then I have a Monaco editor with SQL syntax highlighting

      - Given I write a SQL query
        When I execute it
        Then results are displayed in a table

      - Given my query has errors
        When I execute it
        Then I see error messages with line numbers

      - Given I have a successful query
        When I save it
        Then it's available for reuse and sharing

    test_scenarios:
      - name: Execute simple SELECT query
        type: integration
        setup: |
          await createAthenaTable('pmbook_db', 'contracts', {
            location: 's3://my-bucket/contracts/',
            columns: ['id', 'contract_number', 'status', 'total_value']
          });
          await seedS3Data('s3://my-bucket/contracts/', [
            { id: '1', contract_number: 'ABC123', status: 'active', total_value: 1000000 }
          ]);
        steps:
          - action: open_athena_editor
            expect:
              monaco_editor_visible: true
              syntax_highlighting_enabled: true

          - action: type_query
            query: |
              SELECT contract_number, status, total_value
              FROM pmbook_db.contracts
              WHERE status = 'active'
              LIMIT 10
            expect:
              query_in_editor: true

          - action: execute_query
            expect:
              success: true
              results.length_gt: 0
              columns: ['contract_number', 'status', 'total_value']

      - name: Handle SQL errors
        type: integration
        steps:
          - action: type_query
            query: |
              SELECT * FROM non_existent_table

          - action: execute_query
            expect:
              success: false
              error_message.contains: Table not found
              error_line_number: defined

      - name: Save and reuse query
        type: integration
        steps:
          - action: type_query
            query: |
              SELECT * FROM pmbook_db.contracts
              WHERE status = 'active'

          - action: save_query
            params:
              name: Active Contracts
              description: Query for all active contracts
            expect:
              success: true
              query_id: defined

          - action: load_saved_query
            query_id: ${queryId}
            expect:
              query_loaded_in_editor: true

      - name: Export query results
        type: integration
        setup: |
          await executeAthenaQuery('SELECT * FROM pmbook_db.contracts LIMIT 10');
        steps:
          - action: export_results
            params:
              format: csv
            expect:
              success: true
              file_downloaded: true

      - name: Autocomplete suggestions
        type: e2e
        steps:
          - action: type_query
            query: "SELECT * FROM pmbook_db."

          - action: trigger_autocomplete
            expect:
              suggestions_visible: true
              suggestions.includes: contracts
              suggestions.includes: clins

  # ==========================================================================
  # STORY 4: CloudWatch Time-Series Visualization
  # ==========================================================================
  - id: US-AWS-004
    title: As a system admin, I want to visualize CloudWatch metrics
    description: |
      I need to visualize time-series metrics from CloudWatch so I can monitor
      system performance and identify trends.

    priority: P1
    story_points: 3

    acceptance_criteria:
      - Given I open CloudWatch metrics
        When I select a metric
        Then I see an interactive time-series chart

      - Given I have a chart displayed
        When I change the time range
        Then the chart updates to show data for that range

      - Given I want to compare metrics
        When I add multiple metrics to the chart
        Then I see them overlaid with different colors

      - Given I identify an anomaly
        When I set an alarm threshold
        Then I can configure alerts for that metric

    test_scenarios:
      - name: View single metric
        type: integration
        setup: |
          await publishCloudWatchMetrics([
            { namespace: 'Captify/API', metric: 'RequestCount', value: 100, timestamp: '2025-11-07T10:00:00Z' },
            { namespace: 'Captify/API', metric: 'RequestCount', value: 150, timestamp: '2025-11-07T11:00:00Z' },
            { namespace: 'Captify/API', metric: 'RequestCount', value: 120, timestamp: '2025-11-07T12:00:00Z' }
          ]);
        steps:
          - action: navigate_to
            url: /ontology/aws/cloudwatch
            expect:
              metrics_visible: true

          - action: select_metric
            params:
              namespace: Captify/API
              metric_name: RequestCount
            expect:
              chart_visible: true
              data_points.length: 3

      - name: Change time range
        type: integration
        steps:
          - action: select_metric
            params:
              namespace: Captify/API
              metric_name: RequestCount

          - action: set_time_range
            params:
              start: 2025-11-07T00:00:00Z
              end: 2025-11-07T23:59:59Z
            expect:
              chart_updated: true
              time_range_displayed: 24h

      - name: Compare multiple metrics
        type: integration
        setup: |
          await publishCloudWatchMetrics([
            { namespace: 'Captify/API', metric: 'RequestCount', value: 100 },
            { namespace: 'Captify/API', metric: 'ErrorCount', value: 5 }
          ]);
        steps:
          - action: select_metrics
            params:
              metrics:
                - { namespace: 'Captify/API', metric: 'RequestCount' }
                - { namespace: 'Captify/API', metric: 'ErrorCount' }
            expect:
              chart_shows_multiple_series: true
              series.length: 2
              series[0].color: defined
              series[1].color: defined

      - name: Configure alarm threshold
        type: integration
        steps:
          - action: select_metric
            params:
              namespace: Captify/API
              metric_name: ErrorCount

          - action: create_alarm
            params:
              threshold: 10
              comparison: GreaterThanThreshold
              evaluation_periods: 2
              notification: slack
            expect:
              success: true
              alarm_created: true

  # ==========================================================================
  # STORY 5: QuickSight Dashboard Embedding
  # ==========================================================================
  - id: US-AWS-005
    title: As a business analyst, I want to view QuickSight dashboards
    description: |
      I need to view QuickSight dashboards embedded in the ontology UI so I can
      access BI analytics without leaving the application.

    priority: P1
    story_points: 3

    acceptance_criteria:
      - Given I have QuickSight dashboards available
        When I open the QuickSight section
        Then I see a gallery of available dashboards

      - Given I select a dashboard
        When I click on it
        Then it opens in an embedded iframe with interactive filters

      - Given dashboard requires parameters
        When I provide parameter values
        Then the dashboard updates with filtered data

      - Given I want to share a dashboard
        When I generate a share link
        Then I can share the dashboard with colleagues

    test_scenarios:
      - name: View dashboard gallery
        type: integration
        setup: |
          await createQuickSightDashboards([
            { id: 'dash-1', name: 'Contract Analytics', status: 'published' },
            { id: 'dash-2', name: 'Revenue Overview', status: 'published' }
          ]);
        steps:
          - action: navigate_to
            url: /ontology/aws/quicksight
            expect:
              dashboards_visible: true
              dashboards.length: 2

      - name: Embed and view dashboard
        type: integration
        setup: |
          const dashboard = await createQuickSightDashboard({
            id: 'dash-1',
            name: 'Contract Analytics'
          });
        steps:
          - action: click_dashboard
            dashboard_id: dash-1
            expect:
              embed_url_generated: true
              iframe_visible: true
              iframe_src.contains: quicksight

      - name: Apply dashboard parameters
        type: integration
        setup: |
          await createQuickSightDashboard({
            id: 'dash-1',
            parameters: ['start_date', 'end_date', 'status']
          });
        steps:
          - action: open_dashboard
            dashboard_id: dash-1

          - action: set_parameters
            params:
              start_date: 2025-01-01
              end_date: 2025-12-31
              status: active
            expect:
              dashboard_updated: true
              parameters_applied: true

      - name: Generate share link
        type: integration
        steps:
          - action: open_dashboard
            dashboard_id: dash-1

          - action: generate_share_link
            params:
              expires_in_hours: 24
            expect:
              success: true
              share_url: defined
              share_url.contains: quicksight

  # ==========================================================================
  # STORY 6: Kendra Semantic Search
  # ==========================================================================
  - id: US-AWS-006
    title: As a user, I want to search the ontology with natural language
    description: |
      I need semantic search powered by AWS Kendra so I can find entities,
      documents, and relationships using natural language queries.

    priority: P0
    story_points: 5

    acceptance_criteria:
      - Given I open the search interface
        When I type a natural language query
        Then I see relevant results ranked by relevance

      - Given search results are displayed
        When I view a result
        Then I see highlighted excerpts showing why it matched

      - Given I want to refine results
        When I apply faceted filters
        Then results are filtered by entity type, domain, or category

      - Given I find a relevant entity
        When I click on it
        Then it opens in the ontology viewer

    test_scenarios:
      - name: Natural language search
        type: integration
        setup: |
          await indexInKendra([
            { id: 'c1', type: 'contract', text: 'Software development contract for AI platform' },
            { id: 'c2', type: 'contract', text: 'Hardware procurement contract for servers' },
            { id: 'u1', type: 'user', text: 'John Smith - Senior Engineer' }
          ]);
        steps:
          - action: navigate_to
            url: /ontology/aws/kendra
            expect:
              search_box_visible: true

          - action: search
            query: "AI software development"
            expect:
              success: true
              results.length_gt: 0
              results[0].id: c1
              results[0].relevance_gt: results[1].relevance

      - name: View search result excerpts
        type: integration
        setup: |
          await indexInKendra([
            { id: 'c1', text: 'This contract covers AI platform development including machine learning models and data pipelines' }
          ]);
        steps:
          - action: search
            query: "machine learning"

          - action: view_result
            result_index: 0
            expect:
              excerpt_visible: true
              excerpt.contains: machine learning
              highlighted_text: machine learning

      - name: Apply faceted filters
        type: integration
        setup: |
          await indexInKendra([
            { id: 'c1', type: 'contract', domain: 'PMBook' },
            { id: 'c2', type: 'contract', domain: 'Core' },
            { id: 'u1', type: 'user', domain: 'Core' }
          ]);
        steps:
          - action: search
            query: "*"  # Match all

          - action: apply_facet_filter
            params:
              facet: type
              value: contract
            expect:
              results.length: 2
              results.every(r => r.type === 'contract'): true

      - name: Open entity from search
        type: e2e
        steps:
          - action: search
            query: "contract ABC123"

          - action: click_result
            result_index: 0
            expect:
              ontology_viewer_opened: true
              entity_loaded: true

  # ==========================================================================
  # STORY 7: S3 File Browser
  # ==========================================================================
  - id: US-AWS-007
    title: As a user, I want to browse and manage S3 files
    description: |
      I need an S3 file browser so I can view, upload, download, and manage files
      stored in S3 buckets related to ontology entities.

    priority: P1
    story_points: 3

    acceptance_criteria:
      - Given I open the S3 browser
        When I select a bucket
        Then I see a tree view of folders and files

      - Given I navigate to a folder
        When I click on a file
        Then I can preview it (if supported) or download it

      - Given I want to upload files
        When I drag and drop files
        Then they are uploaded to the current folder

      - Given I have files selected
        When I use bulk actions
        Then I can delete, move, or copy multiple files at once

    test_scenarios:
      - name: Browse S3 bucket
        type: integration
        setup: |
          await createS3Files('my-bucket', [
            { key: 'contracts/ABC123/contract.pdf', size: 1024000 },
            { key: 'contracts/ABC123/amendment1.pdf', size: 512000 },
            { key: 'contracts/ABC124/contract.pdf', size: 2048000 }
          ]);
        steps:
          - action: navigate_to
            url: /ontology/aws/s3
            expect:
              buckets_visible: true

          - action: select_bucket
            bucket_name: my-bucket
            expect:
              folders_visible: true
              folders.includes: contracts

          - action: navigate_to_folder
            path: contracts/ABC123
            expect:
              files.length: 2
              files[0].key: contract.pdf

      - name: Preview file
        type: integration
        setup: |
          await uploadS3File('my-bucket', 'documents/report.pdf', pdfBuffer);
        steps:
          - action: click_file
            file_key: documents/report.pdf
            expect:
              preview_dialog_visible: true
              pdf_viewer_loaded: true

      - name: Upload files via drag-and-drop
        type: e2e
        steps:
          - action: navigate_to_folder
            path: uploads

          - action: drag_and_drop_files
            files:
              - { name: 'file1.pdf', size: 1024 }
              - { name: 'file2.pdf', size: 2048 }
            expect:
              upload_progress_visible: true
              files_uploaded: 2

          - action: wait_for_uploads
            expect:
              success: true
              uploads_complete: true

      - name: Bulk delete files
        type: integration
        setup: |
          await createS3Files('my-bucket', [
            { key: 'temp/file1.txt' },
            { key: 'temp/file2.txt' },
            { key: 'temp/file3.txt' }
          ]);
        steps:
          - action: select_files
            file_keys:
              - temp/file1.txt
              - temp/file2.txt

          - action: bulk_delete
            expect:
              success: true
              deleted_count: 2

          - action: list_files
            path: temp
            expect:
              files.length: 1

      - name: Download file
        type: e2e
        setup: |
          await uploadS3File('my-bucket', 'downloads/report.pdf', pdfBuffer);
        steps:
          - action: click_file
            file_key: downloads/report.pdf

          - action: click_download
            expect:
              download_started: true
              file_downloaded: true

testing:
  unit_tests:
    framework: vitest
    coverage_target: 85
    files:
      - platform/src/app/ontology/aws/**/*.test.tsx

  integration_tests:
    framework: vitest
    setup: |
      await setupTestAWSServices();
      await seedTestData();
    teardown: |
      await cleanupTestAWSServices();
    files:
      - tests/integration/aws/*.test.ts

  e2e_tests:
    framework: playwright
    scenarios:
      - User builds and executes DynamoDB query
      - User browses Glue catalog and maps table to ontology
      - User executes Athena SQL query
      - User views CloudWatch metrics chart
      - User embeds QuickSight dashboard
      - User performs Kendra semantic search
      - User browses S3 bucket and uploads files

deployment:
  environments:
    - name: dev
      auto_deploy: true
      on: push to main

    - name: staging
      auto_deploy: false
      requires_approval: true

    - name: production
      auto_deploy: false
      requires_approval: true
      smoke_tests: true

monitoring:
  metrics:
    - name: aws_api_call_count
      type: counter
      labels: [service, operation, status]

    - name: aws_api_latency
      type: histogram
      labels: [service, operation]
      buckets: [100, 500, 1000, 2000, 5000]

    - name: s3_upload_count
      type: counter
      labels: [bucket, status]

    - name: athena_query_duration
      type: histogram
      labels: [database]
      buckets: [1000, 5000, 10000, 30000, 60000]

  alerts:
    - name: aws_api_error_rate_high
      condition: aws_api_error_rate > 0.05
      severity: warning
      notification: slack

    - name: athena_query_slow
      condition: athena_query_duration.p95 > 30000
      severity: warning
      notification: slack

documentation:
  - file: features/04-aws-integration.md
    type: feature_spec

  - file: AWS-INTEGRATION-GUIDE.md
    type: user_guide

  - file: AWS-SERVICES-API.md
    type: api_reference
