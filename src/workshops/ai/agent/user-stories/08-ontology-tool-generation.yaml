feature:
  id: "08"
  name: "Ontology-to-Tool Auto-Generation"
  description: "Generic CRUD tools that dynamically resolve entity types from ontology"
  priority: "P0"
  story_points: 13
  dependencies:
    - "ontology service (core/services/ontology)"
    - "API client (core/lib/api.ts)"
    - "AgentClient (core/services/agent/client.ts)"

stories:
  - id: "US-08-01"
    title: "Initialize tool generator with ontology discovery"
    as_a: "developer"
    i_want: "the tool generator to automatically discover entity types from the ontology"
    so_that: "I don't need to manually configure which entities are available"
    acceptance_criteria:
      - "Tool generator loads all ontology nodes on initialization"
      - "Filters nodes to only include entities with dataSource property"
      - "Extracts entity type, name, description, and table name from each node"
      - "Creates Zod enum with all available entity types"
      - "Caches ontology nodes with 5-minute TTL"
    tests:
      - name: "should load ontology nodes on initialization"
        given: "AWS credentials are provided"
        when: "initializeTools() is called"
        then: "getAllNodes() is called with credentials"
        and: "entity types are extracted from nodes with dataSource"

      - name: "should filter nodes to only entities with dataSource"
        given: "ontology contains nodes with various categories"
        when: "tool generator processes nodes"
        then: "only nodes with category='entity' and properties.dataSource are included"

      - name: "should create Zod enum from entity types"
        given: "entities: ['user', 'contract', 'notification']"
        when: "tool generator creates validation schemas"
        then: "Zod enum is created with all entity types"
        and: "enum can be used for parameter validation"

      - name: "should cache ontology nodes with 5-minute TTL"
        given: "ontology nodes are loaded"
        when: "5 minutes have not elapsed"
        then: "subsequent calls use cached nodes"
        and: "no additional API calls are made"

      - name: "should refresh cache after 5 minutes"
        given: "ontology nodes are cached"
        when: "5 minutes have elapsed"
        then: "next initialization reloads nodes from DynamoDB"

  - id: "US-08-02"
    title: "Generic getEntity tool with dynamic table resolution"
    as_a: "AI agent"
    i_want: "to retrieve any entity by ID using a single generic tool"
    so_that: "I can access data without needing entity-specific functions"
    acceptance_criteria:
      - "Tool accepts entityType and id parameters"
      - "Tool description lists all available entity types with descriptions"
      - "Validates entityType against Zod enum"
      - "Resolves table name from ontology node"
      - "Calls API with service='platform.dynamodb', operation='get'"
      - "Returns full entity object from DynamoDB"
    tests:
      - name: "should retrieve entity by ID"
        given: "entityType='contract' and id='CONT-123'"
        when: "getEntity tool is executed"
        then: "ontology node 'pmbook-contract' is looked up"
        and: "table name 'pmbook-contract' is resolved"
        and: "API is called with service='platform.dynamodb', operation='get', table='pmbook-contract'"
        and: "entity is returned"

      - name: "should validate entityType against ontology"
        given: "entityType='invalidType'"
        when: "getEntity tool is executed"
        then: "Zod validation fails with error message"
        and: "no API call is made"

      - name: "should include all entity types in tool description"
        given: "ontology has 57 entity types"
        when: "tool description is generated"
        then: "description includes list of all 57 types with descriptions"
        and: "AI can see available entity types"

      - name: "should handle missing entity"
        given: "entityType='user' and id='nonexistent'"
        when: "getEntity tool is executed"
        then: "API returns null or empty result"
        and: "tool returns null gracefully"

  - id: "US-08-03"
    title: "Generic queryEntities tool with dynamic filtering"
    as_a: "AI agent"
    i_want: "to query entities with filters using a single generic tool"
    so_that: "I can search and filter any entity type"
    acceptance_criteria:
      - "Tool accepts entityType, filters, and limit parameters"
      - "Validates entityType against Zod enum"
      - "Resolves table name from ontology node"
      - "Calls API with service='platform.dynamodb', operation='query'"
      - "Supports KeyConditionExpression and FilterExpression"
      - "Returns array of matching entities"
    tests:
      - name: "should query entities with filters"
        given: "entityType='contract' and filters={ status: 'active' }"
        when: "queryEntities tool is executed"
        then: "table name 'pmbook-contract' is resolved"
        and: "API is called with query filters"
        and: "array of active contracts is returned"

      - name: "should support limit parameter"
        given: "entityType='user' and limit=10"
        when: "queryEntities tool is executed"
        then: "API is called with limit=10"
        and: "maximum 10 results are returned"

      - name: "should handle GSI queries"
        given: "entityType='notification' and filters use GSI"
        when: "queryEntities tool is executed"
        then: "IndexName is included in API call"
        and: "GSI is queried correctly"

      - name: "should return empty array when no matches"
        given: "filters match no entities"
        when: "queryEntities tool is executed"
        then: "empty array is returned"
        and: "no error is thrown"

  - id: "US-08-04"
    title: "Generic createEntity tool with schema validation"
    as_a: "AI agent"
    i_want: "to create new entities with automatic schema validation"
    so_that: "I can add data to any table with type safety"
    acceptance_criteria:
      - "Tool accepts entityType and data parameters"
      - "Generates Zod schema from ontology node's JSON schema"
      - "Validates data against schema before API call"
      - "Calls API with service='platform.dynamodb', operation='put'"
      - "Adds timestamps (createdAt, updatedAt) automatically"
      - "Returns created entity with generated ID if not provided"
    tests:
      - name: "should create entity with valid data"
        given: "entityType='contract' and valid contract data"
        when: "createEntity tool is executed"
        then: "data is validated against contract schema"
        and: "createdAt and updatedAt timestamps are added"
        and: "API is called with operation='put'"
        and: "created entity is returned"

      - name: "should validate required fields"
        given: "entityType='contract' and data missing required field"
        when: "createEntity tool is executed"
        then: "Zod validation fails with missing field error"
        and: "no API call is made"

      - name: "should generate ID if not provided"
        given: "entityType='user' and data without id"
        when: "createEntity tool is executed"
        then: "unique ID is generated (e.g., uuid)"
        and: "entity is created with generated ID"

      - name: "should validate field types from schema"
        given: "entityType='contract' and totalValue='not-a-number'"
        when: "createEntity tool is executed"
        then: "Zod validation fails with type error"
        and: "error message indicates expected type"

  - id: "US-08-05"
    title: "Generic updateEntity tool with partial updates"
    as_a: "AI agent"
    i_want: "to update entity fields using a single generic tool"
    so_that: "I can modify any entity without entity-specific code"
    acceptance_criteria:
      - "Tool accepts entityType, id, and updates parameters"
      - "Validates updates against schema (partial validation)"
      - "Calls API with service='platform.dynamodb', operation='update'"
      - "Updates only specified fields"
      - "Updates updatedAt timestamp automatically"
      - "Returns updated entity"
    tests:
      - name: "should update entity fields"
        given: "entityType='contract', id='CONT-123', updates={ status: 'completed' }"
        when: "updateEntity tool is executed"
        then: "only status field is updated"
        and: "updatedAt timestamp is set to current time"
        and: "API is called with operation='update'"
        and: "updated entity is returned"

      - name: "should validate updated fields against schema"
        given: "updates contain invalid field type"
        when: "updateEntity tool is executed"
        then: "Zod validation fails"
        and: "no API call is made"

      - name: "should handle non-existent entity"
        given: "id does not exist"
        when: "updateEntity tool is executed"
        then: "API returns error or null"
        and: "error is propagated to AI"

      - name: "should support partial updates"
        given: "updates only include 2 of 10 fields"
        when: "updateEntity tool is executed"
        then: "only those 2 fields are modified"
        and: "other fields remain unchanged"

  - id: "US-08-06"
    title: "Generic deleteEntity tool with cascade support"
    as_a: "AI agent"
    i_want: "to delete entities using a single generic tool"
    so_that: "I can remove data from any table"
    acceptance_criteria:
      - "Tool accepts entityType and id parameters"
      - "Calls API with service='platform.dynamodb', operation='delete'"
      - "Returns success confirmation"
      - "Handles cascade delete based on ontology edges (future enhancement)"
    tests:
      - name: "should delete entity by ID"
        given: "entityType='notification', id='notif-123'"
        when: "deleteEntity tool is executed"
        then: "API is called with operation='delete'"
        and: "entity is removed from DynamoDB"
        and: "success confirmation is returned"

      - name: "should handle non-existent entity gracefully"
        given: "id does not exist"
        when: "deleteEntity tool is executed"
        then: "API returns success (idempotent)"
        and: "no error is thrown"

      - name: "should validate entityType"
        given: "entityType='invalidType'"
        when: "deleteEntity tool is executed"
        then: "Zod validation fails"
        and: "no API call is made"

  - id: "US-08-07"
    title: "Integrate generic tools with CaptifyAgentAdapter"
    as_a: "developer"
    i_want: "the CaptifyAgentAdapter to automatically load generic tools"
    so_that: "AI agents can use CRUD operations without manual tool registration"
    acceptance_criteria:
      - "CaptifyAgentAdapter calls initializeTools() on construction"
      - "Tools are stored in adapter's tool registry"
      - "streamText() includes tools in AI SDK config"
      - "Tool calls are executed and results returned to AI"
      - "Tool execution errors are handled gracefully"
    tests:
      - name: "should initialize tools on adapter construction"
        given: "CaptifyAgentAdapter is instantiated"
        when: "constructor runs"
        then: "initializeTools() is called with credentials"
        and: "5 generic tools are loaded"

      - name: "should include tools in streamText config"
        given: "adapter has loaded tools"
        when: "streamMessage() is called"
        then: "tools are passed to streamText({ tools: [...] })"
        and: "AI can see tool descriptions"

      - name: "should execute tool calls from AI"
        given: "AI decides to call getEntity tool"
        when: "tool call event is received"
        then: "tool execute function is invoked"
        and: "result is sent back to AI"
        and: "AI receives entity data"

      - name: "should handle tool execution errors"
        given: "tool execution throws error (e.g., network error)"
        when: "tool is executed"
        then: "error is caught and formatted"
        and: "error message is sent to AI"
        and: "AI can inform user of the error"

      - name: "should support tool call streaming"
        given: "AI makes multiple tool calls in sequence"
        when: "streaming response"
        then: "tool-call chunks are yielded"
        and: "tool-result chunks are yielded"
        and: "final text response includes tool results"

  - id: "US-08-08"
    title: "Generate Zod schemas from ontology JSON schemas"
    as_a: "developer"
    i_want: "Zod validators automatically generated from ontology schemas"
    so_that: "data validation matches the ontology definitions"
    acceptance_criteria:
      - "Function converts JSON Schema to Zod schema"
      - "Supports string, number, boolean, array, object types"
      - "Handles required fields"
      - "Handles enum values"
      - "Handles nested objects and arrays"
      - "Adds descriptions to Zod schema for AI context"
    tests:
      - name: "should convert simple JSON schema to Zod"
        given: |
          schema = {
            type: "object",
            properties: {
              name: { type: "string", required: true },
              age: { type: "number" }
            }
          }
        when: "generateZodSchema(schema) is called"
        then: "Zod schema is created: z.object({ name: z.string(), age: z.number().optional() })"

      - name: "should handle required fields"
        given: "schema has required: ['name', 'email']"
        when: "Zod schema is generated"
        then: "name and email are non-optional"
        and: "other fields are optional"

      - name: "should handle enum values"
        given: "field has enum: ['active', 'inactive', 'pending']"
        when: "Zod schema is generated"
        then: "z.enum(['active', 'inactive', 'pending']) is used"

      - name: "should handle nested objects"
        given: "field type is 'object' with nested properties"
        when: "Zod schema is generated"
        then: "z.object() is nested correctly"
        and: "validation works for nested fields"

      - name: "should handle arrays"
        given: "field type is 'array' with items schema"
        when: "Zod schema is generated"
        then: "z.array() is used with item type"
        and: "array validation works"

      - name: "should add descriptions for AI context"
        given: "schema properties have description fields"
        when: "Zod schema is generated"
        then: "z.describe() is used for each field"
        and: "AI sees field descriptions in tool parameters"

implementation_notes:
  - "Use existing ontology service: getAllNodes(), getNode()"
  - "Use existing API client: apiClient.run()"
  - "Cache ontology nodes with 5-minute TTL using Map + timestamps"
  - "Tool descriptions should be verbose to help AI understand available operations"
  - "Zod validation errors should be clear and actionable"
  - "Consider adding listEntityTypes tool for AI to discover entities dynamically"

non_functional_requirements:
  - "Performance: Tool initialization < 500ms"
  - "Caching: Ontology cache reduces API calls by 95%"
  - "Type Safety: 100% TypeScript coverage with strict mode"
  - "Error Handling: All errors caught and formatted for AI consumption"
  - "Scalability: Works with unlimited entity types without code changes"
