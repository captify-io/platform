version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Debug: Verify monorepo structure and package.json
        - echo "Debugging monorepo structure..."
        - pwd
        - ls -la
        - echo "Checking package.json content..."
        - cat package.json | head -20
        - echo "Verifying Next.js version in package.json..."
        - grep -E '"next".*:' package.json || echo "Next.js not found in dependencies"
        
        # Set up Node.js environment
        - echo "Setting up Node.js environment..."
        - nvm install 22.15.1
        - nvm use 22.15.1
        - node --version
        - npm --version

        # Install pnpm and dependencies
        - echo "Installing pnpm and dependencies..."
        - npm install -g pnpm@latest
        - pnpm --version

        # Clean install to ensure consistency
        - rm -rf node_modules
        - rm -rf .next

        # Install dependencies
        - echo "Installing dependencies..."
        - pnpm install --frozen-lockfile || pnpm install
        
        # Build workspace packages (critical for deployment)
        - echo "Building workspace packages..."
        - pnpm --filter="@captify/api" run build
        - pnpm --filter="@captify/core" run build
        - pnpm --filter="@captify/veripicks" run build
        - echo "✅ All workspace packages built successfully"

        # Verify critical environment variables
        - echo "Verifying critical environment variables..."
        - test -n "${NEXTAUTH_URL}" || (echo "❌ NEXTAUTH_URL is required" && exit 1)
        - test -n "${NEXTAUTH_SECRET}" || (echo "❌ NEXTAUTH_SECRET is required" && exit 1)
        - echo "✅ Critical environment variables verified"

    build:
      commands:
        # Production build
        - echo "Building production Next.js application..."
        - pnpm run build
        - echo "✅ Build completed successfully"

    postBuild:
      commands:
        # Verify build output
        - echo "Verifying build output..."
        - ls -la .next/
        - test -d .next/static || (echo "❌ Static assets not found" && exit 1)
        - echo "✅ Build verification completed"

  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
