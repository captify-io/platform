version: 1
applications:
  - appRoot: .
    env:
      variables:
        AMPLIFY_MONOREPO_APP_ROOT: "."
    frontend:
      phases:
        preBuild:
          commands:
            - echo "AMPLIFY_MONOREPO_APP_ROOT = $AMPLIFY_MONOREPO_APP_ROOT"
            - echo "Setting up Node.js environment..."
            - nvm install 22.15.1
            - nvm use 22.15.1
            - node --version
            - npm --version
            - echo "Debugging monorepo structure..."
            - pwd
            - ls -la
            - echo "Checking package.json content..."
            - cat package.json | head -20
            - echo "Verifying Next.js version in package.json..."
            - grep -E '"next".*:' package.json || echo "Next.js not found in dependencies"
            - echo "Installing pnpm and dependencies..."
            - npm install -g pnpm@latest
            - pnpm --version
            - rm -rf node_modules
            - rm -rf .next
            - echo "Checking lockfile status..."
            - |
              if pnpm install --frozen-lockfile --dry-run 2>/dev/null; then
                echo "âœ… Lockfile is up to date, installing with frozen lockfile..."
                pnpm install --frozen-lockfile
              else
                echo "âš ï¸  Installing dependencies without frozen lockfile..."
                pnpm install
                echo "âœ… Dependencies installed successfully"
              fi
            - echo "Debugging node_modules structure..."
            - ls -la node_modules/ | head -5 || echo "No node_modules directory"
            - ls -la node_modules/.bin/ | head -10 || echo "No .bin directory"
            - echo "Checking for turbo specifically..."
            - ls -la node_modules/.bin/turbo* || echo "Turbo not found in .bin"
            - which turbo || echo "Turbo not in PATH"
            - echo "Verifying dependencies..."
            - pnpm list --depth=0 | grep -E "(turbo|typescript)" || echo "Key dependencies verification"
            - echo "Building workspace packages..."
            - echo "Building @captify/api package..."
            - pnpm --filter="@captify/api" run build || (echo "âŒ @captify/api build failed" && exit 1)
            - echo "Building @captify/core package..."
            - pnpm --filter="@captify/core" run build || (echo "âŒ @captify/core build failed" && exit 1)
            - echo "Building @captify/veripicks package..."
            - pnpm --filter="@captify/veripicks" run build || (echo "âŒ @captify/veripicks build failed" && exit 1)
            - echo "âœ… All workspace packages built successfully"
            - echo "Verifying critical environment variables..."
            - test -n "${NEXTAUTH_URL}" || (echo "âŒ NEXTAUTH_URL is required" && exit 1)
            - test -n "${NEXTAUTH_SECRET}" || (echo "âŒ NEXTAUTH_SECRET is required" && exit 1)
            - test -n "${NEXT_PUBLIC_COGNITO_CLIENT_ID}" || (echo "âŒ NEXT_PUBLIC_COGNITO_CLIENT_ID is required" && exit 1)
            - test -n "${COGNITO_CLIENT_SECRET}" || (echo "âŒ COGNITO_CLIENT_SECRET is required" && exit 1)
            - test -n "${ACCESS_KEY_ID}" || (echo "âŒ ACCESS_KEY_ID is required" && exit 1)
            - test -n "${SECRET_ACCESS_KEY}" || (echo "âŒ SECRET_ACCESS_KEY is required" && exit 1)
            - test -n "${MI_DYNAMODB_TABLE}" || (echo "âŒ MI_DYNAMODB_TABLE is required for MI APIs" && exit 1)
            - echo "âœ… Critical environment variables verified"
        build:
          commands:
            - echo "ðŸš€ Starting production build..."
            - echo "Creating .env.production..."
            - |
              cat > .env.production << EOF
              NODE_ENV=production
              NEXTAUTH_URL=${NEXTAUTH_URL}
              NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
              OPENAI_API_KEY=${OPENAI_API_KEY}
              ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
              AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
              AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
              GROQ_API_KEY=${GROQ_API_KEY}
              NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
              NEXT_PUBLIC_COGNITO_ISSUER=${NEXT_PUBLIC_COGNITO_ISSUER}
              NEXT_PUBLIC_BEDROCK_AGENT_ID=${NEXT_PUBLIC_BEDROCK_AGENT_ID}
              COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
              COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
              COGNITO_IDENTITY_POOL_ID=${COGNITO_IDENTITY_POOL_ID}
              COGNITO_SERVICE_CATALOG_POOL_ID=${COGNITO_SERVICE_CATALOG_POOL_ID}
              COGNITO_DOMAIN=${COGNITO_DOMAIN}
              REGION=${REGION}
              ACCESS_KEY_ID=${ACCESS_KEY_ID}
              SECRET_ACCESS_KEY=${SECRET_ACCESS_KEY}
              BEDROCK_AGENT_ID=${BEDROCK_AGENT_ID}
              BEDROCK_AGENT_ALIAS_ID=${BEDROCK_AGENT_ALIAS_ID}
              S3_BUCKET=${S3_BUCKET}
              S3_REGION=${S3_REGION}
              DYNAMODB_APPLICATIONS_TABLE=${DYNAMODB_APPLICATIONS_TABLE}
              DYNAMODB_USER_APPLICATION_STATE_TABLE=${DYNAMODB_USER_APPLICATION_STATE_TABLE}
              DYNAMODB_ORGANIZATION_SETTINGS_TABLE=${DYNAMODB_ORGANIZATION_SETTINGS_TABLE}
              DYNAMODB_MENU_ITEMS_TABLE=${DYNAMODB_MENU_ITEMS_TABLE}
              DYNAMODB_WORKSPACE_CONTENT_TABLE=${DYNAMODB_WORKSPACE_CONTENT_TABLE}
              DYNAMODB_CHAT_TABLE=${DYNAMODB_CHAT_TABLE}
              MI_DYNAMODB_TABLE=${MI_DYNAMODB_TABLE}
              AGENTS_TABLE_NAME=${AGENTS_TABLE_NAME}
              AGENT_JOBS_TABLE_NAME=${AGENT_JOBS_TABLE_NAME}
              API_GATEWAY_URL=${API_GATEWAY_URL}
              DEBUG_MODE=${DEBUG_MODE}
              EOF
            - export NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
            - export NEXT_PUBLIC_COGNITO_ISSUER=${NEXT_PUBLIC_COGNITO_ISSUER}
            - export NEXT_PUBLIC_BEDROCK_AGENT_ID=${NEXT_PUBLIC_BEDROCK_AGENT_ID}
            - echo "Running type check..."
            - pnpm run type-check
            - echo "Running linting..."
            - pnpm run lint
            - echo "Building Next.js application..."
            - pnpm run build
            - cp .env.production .next/
            - echo "âœ… Build completed successfully"
            - ls -la .next/
        postBuild:
          commands:
            - echo "Verifying build output..."
            - test -f .next/BUILD_ID || (echo "âŒ BUILD_ID not found" && exit 1)
            - test -d .next/static || (echo "âŒ Static assets not found" && exit 1)
            - test -f .next/package.json || (echo "âŒ Next.js package.json not found" && exit 1)
            - echo "Build verification - Next.js BUILD_ID: $(cat .next/BUILD_ID 2>/dev/null || echo 'Unknown')"
            - echo "Build verification - Static assets count: $(find .next/static -type f 2>/dev/null | wc -l || echo '0')"
            - echo "âœ… Build verification completed successfully"
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
        excludePaths:
          - node_modules/**/*
          - .git/**/*
          - "*.log"
          - coverage/**/*
      cache:
        paths:
          - .next/cache/**/*
          - node_modules/.pnpm/**/*
          - ~/.pnpm-store/**/*
