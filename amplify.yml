version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 22.15.1
        - nvm use 22.15.1
        - npm install -g pnpm@latest
        - pnpm store prune
        - rm -rf node_modules
        - pnpm install --frozen-lockfile
    build:
      commands:
        - echo "Setting environment variables from Amplify console"
        - echo "Verifying environment variables..."
        - echo "NEXTAUTH_URL=${NEXTAUTH_URL}"
        - echo "NEXTAUTH_SECRET=${NEXTAUTH_SECRET:0:10}..." # Only show first 10 chars
        - echo "NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}"
        - echo "NEXT_PUBLIC_COGNITO_ISSUER=${NEXT_PUBLIC_COGNITO_ISSUER}"
        - echo "REGION=${REGION}"
        - echo "NODE_ENV=${NODE_ENV}"
        - echo "Creating .env.production for runtime environment variables..."
        - echo "NEXTAUTH_URL=${NEXTAUTH_URL}" > .env.production
        - echo "NEXTAUTH_SECRET=${NEXTAUTH_SECRET}" >> .env.production
        - echo "NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}" >> .env.production
        - echo "NEXT_PUBLIC_COGNITO_ISSUER=${NEXT_PUBLIC_COGNITO_ISSUER}" >> .env.production
        - echo "COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}" >> .env.production
        - echo "COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}" >> .env.production
        - echo "COGNITO_SERVICE_CATALOG_POOL_ID=${COGNITO_SERVICE_CATALOG_POOL_ID}" >> .env.production
        - echo "COGNITO_DOMAIN=${COGNITO_DOMAIN}" >> .env.production
        - echo "REGION=${REGION}" >> .env.production
        - echo "ACCESS_KEY_ID=${ACCESS_KEY_ID}" >> .env.production
        - echo "SECRET_ACCESS_KEY=${SECRET_ACCESS_KEY}" >> .env.production
        - echo "BEDROCK_AGENT_ID=${BEDROCK_AGENT_ID}" >> .env.production
        - echo "BEDROCK_AGENT_ALIAS_ID=${BEDROCK_AGENT_ALIAS_ID}" >> .env.production
        - echo "BEDROCK_SESSION_ID=${BEDROCK_SESSION_ID}" >> .env.production
        - echo "NEXT_PUBLIC_BEDROCK_AGENT_ID=${NEXT_PUBLIC_BEDROCK_AGENT_ID}" >> .env.production
        - echo "S3_BUCKET=${S3_BUCKET}" >> .env.production
        - echo "S3_REGION=${S3_REGION}" >> .env.production
        - echo "API_GATEWAY_URL=${API_GATEWAY_URL}" >> .env.production
        - echo "NODE_ENV=production" >> .env.production
        - echo "Environment variables written to .env.production"
        - cat .env.production
        - echo "Environment variables loaded, starting build..."
        - export NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
        - export NEXT_PUBLIC_COGNITO_ISSUER=${NEXT_PUBLIC_COGNITO_ISSUER}
        - export NEXT_PUBLIC_BEDROCK_AGENT_ID=${NEXT_PUBLIC_BEDROCK_AGENT_ID}
        - pnpm run build
        - echo "Copying .env.production to build output"
        - cp .env.production .next/
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
    excludePaths:
      - node_modules/**/*
  cache:
    paths:
      - .next/cache/**/*
      - node_modules/.pnpm/**/*
  environment:
    variables:
      NODE_ENV: production
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      NEXT_PUBLIC_COGNITO_CLIENT_ID: ${NEXT_PUBLIC_COGNITO_CLIENT_ID}
      NEXT_PUBLIC_COGNITO_ISSUER: ${NEXT_PUBLIC_COGNITO_ISSUER}
      COGNITO_CLIENT_SECRET: ${COGNITO_CLIENT_SECRET}
      COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
      COGNITO_SERVICE_CATALOG_POOL_ID: ${COGNITO_SERVICE_CATALOG_POOL_ID}
      COGNITO_DOMAIN: ${COGNITO_DOMAIN}
      REGION: ${REGION}
      ACCESS_KEY_ID: ${ACCESS_KEY_ID}
      SECRET_ACCESS_KEY: ${SECRET_ACCESS_KEY}
      BEDROCK_AGENT_ID: ${BEDROCK_AGENT_ID}
      BEDROCK_AGENT_ALIAS_ID: ${BEDROCK_AGENT_ALIAS_ID}
      BEDROCK_SESSION_ID: ${BEDROCK_SESSION_ID}
      NEXT_PUBLIC_BEDROCK_AGENT_ID: ${NEXT_PUBLIC_BEDROCK_AGENT_ID}
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${S3_REGION}
      API_GATEWAY_URL: ${API_GATEWAY_URL}
